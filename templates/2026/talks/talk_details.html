{% extends "base.html" %}
{% load i18n static avatar_tags crispy_forms_tags markdown_extras embed_video_tags %}

{% block meta_title %}{% if page %}{{ page.meta_title }}{% else %}{% trans "Talk Detail || PyCon Africa 2026" %}{% endif %}{% endblock %}

{% block extra_css %}
<style>
  .profile-nav-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 0.75rem;
    color: #374151;
    text-decoration: none;
    border-radius: 0.5rem;
    font-size: 0.9375rem;
  }
  @media (max-width: 640px) {
    .profile-nav-link {
      padding: 0.75rem;
      font-size: 0.875rem;
    }
  }
  .profile-nav-link:hover {
    background: #f3f4f6;
    color: #111827;
  }
  .profile-nav-link.active {
    background: #0d9488;
    color: #fff;
  }
  .profile-nav-link.active:hover {
    background: #0f766e;
    color: #fff;
  }
</style>
{% endblock %}

{% block content %}
{% include '2026/navbar.html' %}

<div class="auth-page-content min-h-screen bg-gray-50">
  <!-- Header -->
  <header class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 py-3 sm:py-4 sm:px-6 lg:px-8">
      <nav aria-label="breadcrumb" class="mb-1.5 sm:mb-2">
        <ol class="flex flex-wrap items-center gap-1 text-xs sm:text-sm text-gray-500 list-none p-0 m-0">
          <li><a class="text-pycon-teal hover:underline" href="/2026/">{% trans "Home" %}</a></li>
          <li><span class="text-gray-400" aria-hidden="true">/</span></li>
          <li><a class="text-pycon-teal hover:underline" href="/accounts/profile/">{% trans "Profile" %}</a></li>
          <li><span class="text-gray-400" aria-hidden="true">/</span></li>
          <li><a class="text-pycon-teal hover:underline" href="{% url 'talks:talk_list' year=year %}">{% trans "My Submitted Talks" %}</a></li>
          <li><span class="text-gray-400" aria-hidden="true">/</span></li>
          <li class="text-gray-700" aria-current="page">{{ talk.title|truncatewords:7 }}</li>
        </ol>
      </nav>
      <h1 class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-900">
        {{ talk.title }}
      </h1>
    </div>
  </header>

  <section class="max-w-6xl mx-auto px-4 py-6 sm:py-8 sm:px-6 lg:px-8">
    <div class="flex flex-col md:flex-row gap-6 lg:gap-10">
      <!-- Sidebar -->
      <aside class="w-full md:w-64 shrink-0 md:order-1 order-2">
        <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden md:sticky md:top-24">
          <div class="p-4 sm:p-5">
            <div class="mb-4 flex justify-center">
              <div class="w-24 h-24 sm:w-28 sm:h-28 rounded-full overflow-hidden border-2 border-gray-100 shadow-sm [&_img]:w-full [&_img]:h-full [&_img]:object-cover">
                {% include 'profiles/profilepic_side.html' %}
              </div>
            </div>
            {% if request.user.last_login %}
            <div class="text-xs text-gray-500 mb-4 pb-4 border-b border-gray-100">
              <span class="font-medium text-gray-400 uppercase tracking-wide">{% trans "Last login" %}</span><br>
              <span class="text-gray-600">{{ request.user.last_login|date:"M. j, Y" }} Â· {{ request.user.last_login|time:"g:i a" }}</span>
            </div>
            {% endif %}
            <nav class="flex flex-col gap-0.5" aria-label="Profile menu">
              <a href="/accounts/profile/" class="profile-nav-link">
                <i class="fa-solid fa-house w-4 text-center" aria-hidden="true"></i>
                <span>My Profile</span>
              </a>
              <a href="{% url 'profiles:profile_update' pk=request.user.user_profile.profile_id.hashid %}" class="profile-nav-link">
                <i class="fa-solid fa-id-card w-4 text-center" aria-hidden="true"></i>
                <span>Update my Profile</span>
              </a>
              <a href="/accounts/password/change/" class="profile-nav-link">
                <i class="fa-solid fa-lock w-4 text-center" aria-hidden="true"></i>
                <span>Change Password</span>
              </a>
              <a href="{% url 'talks:talk_list' year=year %}" class="profile-nav-link active">
                <i class="fa-solid fa-microphone w-4 text-center" aria-hidden="true"></i>
                <span>My Submitted Talks</span>
              </a>
              <a href="{% url 'talks:submit_talk' year=year %}" class="profile-nav-link">
                <i class="fa-solid fa-podium w-4 text-center" aria-hidden="true"></i>
                <span>Submit a new Talk</span>
              </a>
              {% if perms.reviews.add_review or request.user.reviewer_profile or request.user.is_superuser %}
              <a href="{% url 'talks:talks_to_review' year=year %}" class="profile-nav-link">
                <i class="fa-solid fa-list-check w-4 text-center" aria-hidden="true"></i>
                <span>Review Proposals</span>
              </a>
              {% endif %}
              {% if request.user.is_superuser or request.user.reviewer_profile %}
              <a href="{% url 'talks:reviewed_talks_by_category' year=year %}" class="profile-nav-link">
                <i class="fa-solid fa-clipboard-list w-4 text-center" aria-hidden="true"></i>
                <span>Proposals by Category</span>
              </a>
              {% endif %}
            </nav>
          </div>
        </div>
      </aside>

      <!-- Main content -->
      <div class="flex-1 min-w-0 md:order-2 order-1">
        <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden p-4 sm:p-6 lg:p-8 space-y-6">
          <!-- Header + meta -->
          <div class="flex flex-col gap-3 sm:gap-4">
            <div>
              <h2 class="text-lg sm:text-xl font-semibold text-gray-900">
                {{ talk.title }}
              </h2>
              <p class="mt-1 text-sm text-gray-600">
                {% blocktrans %}Presented by{% endblocktrans %}
                {% if talk.user.user_profile.name %}
                  {{ talk.user.user_profile.name }} {{ talk.user.user_profile.surname }}
                {% else %}
                  @{{ talk.user.username|capfirst }}
                {% endif %}
              </p>
            </div>

            <div class="flex flex-wrap gap-2 text-xs sm:text-sm text-gray-700">
              <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5">
                <span class="font-semibold mr-1">{% trans "Type" %}:</span> {{ talk.talk_type }}
              </span>
              <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5">
                <span class="font-semibold mr-1">{% trans "Category" %}:</span> {{ talk.talk_category }}
              </span>
              <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5">
                <span class="font-semibold mr-1">{% trans "Audience" %}:</span> {{ talk.intended_audience }}
              </span>
            </div>

            {% if speakers %}
            <div class="text-sm text-gray-700">
              <span class="font-semibold">{% trans "Additional speakers" %}:</span>
              {% for speaker in speakers %}
                {{ speaker.user_profile.name }} {{ speaker.user_profile.surname }}{% if not forloop.last %},{% endif %}
              {% endfor %}
            </div>
            {% endif %}

            <!-- Status badges -->
            <div class="flex flex-wrap gap-2 items-center text-xs sm:text-sm">
              {% if talk.status == "S" %}
                <span class="inline-flex items-center rounded-full bg-amber-100 px-2.5 py-0.5 font-medium text-amber-800">
                  {% trans "Status: Under review" %}
                </span>
              {% elif talk.status == "A" %}
                <span class="inline-flex items-center rounded-full bg-emerald-100 px-2.5 py-0.5 font-semibold text-emerald-800">
                  {% trans "Status: Accepted" %}
                </span>
              {% elif talk.status == "W" %}
                <span class="inline-flex items-center rounded-full bg-sky-100 px-2.5 py-0.5 font-medium text-sky-800">
                  {% trans "Status: On waitlist" %}
                </span>
              {% elif talk.status == "R" %}
                <span class="inline-flex items-center rounded-full bg-rose-100 px-2.5 py-0.5 font-medium text-rose-800">
                  {% trans "Status: Didn't make the cut" %}
                </span>
              {% elif talk.status == "RS" %}
                <span class="inline-flex items-center rounded-full bg-indigo-100 px-2.5 py-0.5 font-medium text-indigo-800">
                  {% trans "Status: You declined to present" %}
                </span>
              {% endif %}

              {% if request.user.username == talk.user.username %}
                {% if talk.user_response == "A" %}
                  <span class="inline-flex items-center rounded-full bg-emerald-50 px-2.5 py-0.5 font-medium text-emerald-700">
                    {% trans "You have accepted to present" %}
                  </span>
                {% elif talk.user_response == "R" %}
                  <span class="inline-flex items-center rounded-full bg-rose-50 px-2.5 py-0.5 font-medium text-rose-700">
                    {% trans "You have rejected to present" %}
                  </span>
                {% endif %}
              {% endif %}
            </div>
          </div>

          <!-- Preview video -->
          <div class="border-t border-gray-100 pt-4 sm:pt-5">
            <h3 class="text-sm sm:text-base font-semibold text-gray-900 mb-2">
              {% trans "Talk preview video" %}
            </h3>
            {% if talk.link_to_preview_video_url %}
              <div class="aspect-video rounded-xl overflow-hidden border border-gray-200 shadow-sm bg-black">
                {% video talk.link_to_preview_video_url 'tiny' %}
              </div>
            {% else %}
              <p class="text-sm text-gray-600">
                {% trans "You have not yet submitted a preview video for this talk." %}
              </p>
            {% endif %}
          </div>

          <!-- Elevator pitch & abstract -->
          <div class="border-t border-gray-100 pt-4 sm:pt-5 grid gap-4 sm:gap-6 lg:grid-cols-2">
            <div>
              <h3 class="text-sm sm:text-base font-semibold text-gray-900 mb-2">
                {% trans "Elevator pitch" %}
              </h3>
              <div class="prose prose-sm max-w-none text-gray-800">
                {{ talk.elevator_pitch|markdown|safe }}
              </div>
            </div>
            <div>
              <h3 class="text-sm sm:text-base font-semibold text-gray-900 mb-2">
                {% trans "Abstract" %}
              </h3>
              <div class="prose prose-sm max-w-none text-gray-800">
                {{ talk.talk_abstract|markdown|safe }}
              </div>
            </div>
          </div>

          <!-- Owner-only actions: speakers & slides -->
          {% if request.user.username == talk.user.username %}
          <div class="border-t border-gray-100 pt-4 sm:pt-5 space-y-6">
            <!-- Add speakers -->
            <div class="space-y-2">
              <h3 class="text-sm sm:text-base font-semibold text-gray-900">
                {% trans "Add additional speakers" %}
              </h3>
              <p class="text-xs sm:text-sm text-gray-600">
                {% trans "Invite co-speakers by email. Make sure they already have an account on this website." %}
              </p>
              <form action="{% url 'talks:send_speaker_invitation' year=talk.event_year.year pk=talk.pk %}"
                    method="post"
                    class="flex flex-col sm:flex-row gap-2 sm:items-center">
                {% csrf_token %}
                <label for="user_email" class="sr-only">{% trans "Speaker's email" %}</label>
                <input id="user_email"
                       name="user_email"
                       type="email"
                       required
                       class="w-full sm:flex-1 rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-pycon-teal focus:border-pycon-teal"
                       placeholder="{% trans "speaker@example.com" %}">
                <button type="submit"
                        class="inline-flex items-center justify-center px-4 py-2 text-xs sm:text-sm font-semibold rounded-lg bg-pycon-teal text-white hover:bg-teal-700 shadow-sm">
                  {% trans "Send invitation" %}
                </button>
              </form>
            </div>

            <!-- Slides upload -->
            {% if can_upload %}
            <div class="space-y-3">
              <div class="flex items-center justify-between gap-2">
                <h3 class="text-sm sm:text-base font-semibold text-gray-900">
                  {% trans "Slides and supporting material" %}
                </h3>
                {% if has_uploaded_slide and latest_slide %}
                  <a href="{{ latest_slide.document.url }}"
                     target="_blank"
                     class="inline-flex items-center px-3 py-1.5 text-xs font-semibold rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50">
                    <i class="fa-solid fa-file-arrow-down w-4 text-center mr-1.5" aria-hidden="true"></i>
                    <span>{% trans "View latest slide" %}</span>
                  </a>
                {% endif %}
              </div>
              <p class="text-xs sm:text-sm text-gray-600">
                {% trans "Upload or replace your slides and related documents. Accepted formats and limits may apply." %}
              </p>
              <form method="post" enctype="multipart/form-data" class="space-y-3">
                {% csrf_token %}
                <div class="bg-gray-50 rounded-xl border border-dashed border-gray-300 p-4 sm:p-5">
                  {{ form|crispy }}
                </div>
                <button type="submit"
                        class="inline-flex items-center px-4 py-2 text-xs sm:text-sm font-semibold rounded-lg bg-pycon-teal text-white hover:bg-teal-700 shadow-sm">
                  <i class="fa-solid fa-upload w-4 text-center mr-1.5" aria-hidden="true"></i>
                  <span>{% trans "Upload document" %}</span>
                </button>
              </form>
            </div>
            {% endif %}
          </div>
          {% endif %}

          <!-- Footer actions -->
          <div class="border-t border-gray-100 pt-4 sm:pt-5 flex flex-wrap gap-3">
            <a href="{% url 'talks:talk_list' year=year %}"
               class="inline-flex items-center px-4 py-2 text-xs sm:text-sm font-semibold rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50">
              <i class="fa-solid fa-arrow-left w-4 text-center mr-1.5" aria-hidden="true"></i>
              <span>{% trans "Back to my talks" %}</span>
            </a>

            {% if request.user.username == talk.user.username %}
              {% if active_period or talk.user_response == "A" or is_sponsor_or_keynote %}
              <a href="{% url 'talks:edit_talk' year=year pk=talk.pk %}"
                 class="inline-flex items-center px-4 py-2 text-xs sm:text-sm font-semibold rounded-lg bg-pycon-teal text-white hover:bg-teal-700 shadow-sm">
                <i class="fa-solid fa-pen w-4 text-center mr-1.5" aria-hidden="true"></i>
                <span>{% trans "Edit talk" %}</span>
              </a>
              {% else %}
              <span class="inline-flex items-center px-4 py-2 text-xs sm:text-sm font-semibold rounded-lg bg-gray-100 text-gray-400 cursor-not-allowed"
                    title="{% trans 'You cannot edit the talk because the CFP period is over' %}">
                <i class="fa-solid fa-pen w-4 text-center mr-1.5" aria-hidden="true"></i>
                <span>{% trans "Edit talk" %}</span>
              </span>
              {% endif %}
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

{% endblock %}
